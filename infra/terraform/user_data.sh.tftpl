#!/bin/bash
set -euo pipefail

APP_DIR="/opt/${project_name}"
REPO_DIR="$${APP_DIR}/repo"

echo "=== Mem0 Deployment Lab bootstrap starting ==="

# Packages
dnf update -y
dnf install -y git jq awscli

# Docker
dnf install -y docker
systemctl enable docker
systemctl start docker
usermod -aG docker ec2-user || true

# Docker Compose plugin (preferred). Fallback to standalone docker-compose.
if dnf install -y docker-compose-plugin; then
  echo "docker compose plugin installed"
elif command -v docker-compose >/dev/null 2>&1; then
  echo "docker-compose already present"
else
  echo "Installing standalone docker-compose"
  curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  chmod +x /usr/local/bin/docker-compose
fi

mkdir -p "$${APP_DIR}"
cd "$${APP_DIR}"

if [ ! -d "$${REPO_DIR}" ]; then
  git clone "${repo_url}" "$${REPO_DIR}"
fi

cd "$${REPO_DIR}"
git fetch --all
git checkout "${repo_ref}"

# Pull secrets from SSM
API_KEY="$(aws ssm get-parameter --with-decryption --name "${ssm_prefix}/API_KEY" --query Parameter.Value --output text)"
ADMIN_API_KEY="$(aws ssm get-parameter --with-decryption --name "${ssm_prefix}/ADMIN_API_KEY" --query Parameter.Value --output text)"
OPENAI_API_KEY="$(aws ssm get-parameter --with-decryption --name "${ssm_prefix}/OPENAI_API_KEY" --query Parameter.Value --output text || echo '')"

# Write .env for the app
cat > .env <<EOF
LLM_PROVIDER=${llm_provider}
EMBEDDER_PROVIDER=${embedder_provider}

OPENAI_API_KEY=$${OPENAI_API_KEY}
OPENAI_BASE_URL=${openai_base_url}

AWS_REGION=${aws_region_runtime}

QDRANT_HOST=qdrant
QDRANT_PORT=6333

API_HOST=0.0.0.0
API_PORT=${api_port}
API_KEY=$${API_KEY}
ADMIN_API_KEY=$${ADMIN_API_KEY}

LLM_MODEL=${llm_model}
LLM_TEMPERATURE=${llm_temperature}

EMBEDDER_MODEL=${embedder_model}
EOF

echo "=== Starting docker compose ==="

# Run from repo root; compose file lives in deployment/
if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
  docker compose -f deployment/docker-compose.yml up -d --build
else
  docker-compose -f deployment/docker-compose.yml up -d --build
fi

echo "=== Mem0 Deployment Lab bootstrap complete ==="


