#!/bin/bash
set -euo pipefail

# Log everything user-data does (so failures are obvious)
exec > >(tee -a /var/log/mem0-bootstrap.log) 2>&1

APP_DIR="/opt/${project_name}"
REPO_DIR="$${APP_DIR}/repo"

echo "=== Mem0 Deployment Lab bootstrap starting ==="

# Packages
dnf update -y
dnf install -y git jq awscli

# Ensure AWS CLI has a region (otherwise `aws ssm ...` fails with "You must specify a region")
export AWS_REGION="${aws_region_runtime}"
export AWS_DEFAULT_REGION="${aws_region_runtime}"

# Docker
dnf install -y docker
systemctl enable docker
systemctl start docker
usermod -aG docker ec2-user || true

mkdir -p "$${APP_DIR}"
cd "$${APP_DIR}"

if [ ! -d "$${REPO_DIR}" ]; then
  git clone "${repo_url}" "$${REPO_DIR}"
fi

cd "$${REPO_DIR}"
git fetch --all
git checkout "${repo_ref}"
echo "Deployed git ref: $(git rev-parse --short HEAD)"

# Pull secrets from SSM
API_KEY="$(aws ssm get-parameter --region "${aws_region_runtime}" --with-decryption --name "${ssm_prefix}/API_KEY" --query Parameter.Value --output text)"
ADMIN_API_KEY="$(aws ssm get-parameter --region "${aws_region_runtime}" --with-decryption --name "${ssm_prefix}/ADMIN_API_KEY" --query Parameter.Value --output text)"
OPENAI_API_KEY=""
if [ "${llm_provider}" = "openai" ] || [ "${embedder_provider}" = "openai" ]; then
  OPENAI_API_KEY="$(aws ssm get-parameter --region "${aws_region_runtime}" --with-decryption --name "${ssm_prefix}/OPENAI_API_KEY" --query Parameter.Value --output text)"
fi

# Write .env for the app
cat > .env <<EOF
LLM_PROVIDER=${llm_provider}
EMBEDDER_PROVIDER=${embedder_provider}

OPENAI_API_KEY=$${OPENAI_API_KEY}
OPENAI_BASE_URL=${openai_base_url}

AWS_REGION=${aws_region_runtime}

QDRANT_HOST=${qdrant_container_name}
QDRANT_PORT=${qdrant_http_port}

API_HOST=${api_host}
API_PORT=${api_port}
API_KEY=$${API_KEY}
ADMIN_API_KEY=$${ADMIN_API_KEY}

LLM_MODEL=${llm_model}
LLM_TEMPERATURE=${llm_temperature}

EMBEDDER_MODEL=${embedder_model}
EOF

echo "=== Starting containers (docker run) ==="

# Create network if missing
docker network inspect ${docker_network_name} >/dev/null 2>&1 || docker network create ${docker_network_name}

# Start Qdrant (vector DB)
docker rm -f ${qdrant_container_name} >/dev/null 2>&1 || true
docker run -d \
  --name ${qdrant_container_name} \
  --network ${docker_network_name} \
  -p ${qdrant_http_port}:${qdrant_http_port} \
  -p ${qdrant_grpc_port}:${qdrant_grpc_port} \
  -v ${qdrant_volume_name}:/qdrant/storage \
  -e QDRANT__SERVICE__GRPC_PORT=${qdrant_grpc_port} \
  --restart unless-stopped \
  ${qdrant_image}

# Build API image (uses classic docker build; avoids buildx requirements)
echo "=== Building mem0_api image ==="
docker build -t ${api_image_name} -f deployment/Dockerfile .
docker images | head -n 20

# Start Mem0 API
echo "=== Starting mem0_api container ==="
docker rm -f ${api_container_name} >/dev/null 2>&1 || true
docker run -d \
  --name ${api_container_name} \
  --network ${docker_network_name} \
  -p ${api_port}:${api_port} \
  --env-file .env \
  -e QDRANT_HOST=${qdrant_container_name} \
  -e QDRANT_PORT=${qdrant_http_port} \
  --restart unless-stopped \
  ${api_image_name}

echo "=== Mem0 Deployment Lab bootstrap complete ==="


