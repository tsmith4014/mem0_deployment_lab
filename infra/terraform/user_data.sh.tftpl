#!/bin/bash
set -euo pipefail

APP_DIR="/opt/${project_name}"
REPO_DIR="$${APP_DIR}/repo"

echo "=== Mem0 Deployment Lab bootstrap starting ==="

# Packages
dnf update -y
dnf install -y git jq awscli

# Ensure AWS CLI has a region (otherwise `aws ssm ...` fails with "You must specify a region")
export AWS_REGION="${aws_region_runtime}"
export AWS_DEFAULT_REGION="${aws_region_runtime}"

# Docker
dnf install -y docker
systemctl enable docker
systemctl start docker
usermod -aG docker ec2-user || true

mkdir -p "$${APP_DIR}"
cd "$${APP_DIR}"

if [ ! -d "$${REPO_DIR}" ]; then
  git clone "${repo_url}" "$${REPO_DIR}"
fi

cd "$${REPO_DIR}"
git fetch --all
git checkout "${repo_ref}"

# Pull secrets from SSM
API_KEY="$(aws ssm get-parameter --region "${aws_region_runtime}" --with-decryption --name "${ssm_prefix}/API_KEY" --query Parameter.Value --output text)"
ADMIN_API_KEY="$(aws ssm get-parameter --region "${aws_region_runtime}" --with-decryption --name "${ssm_prefix}/ADMIN_API_KEY" --query Parameter.Value --output text)"
OPENAI_API_KEY="$(aws ssm get-parameter --region "${aws_region_runtime}" --with-decryption --name "${ssm_prefix}/OPENAI_API_KEY" --query Parameter.Value --output text || echo '')"

# Write .env for the app
cat > .env <<EOF
LLM_PROVIDER=${llm_provider}
EMBEDDER_PROVIDER=${embedder_provider}

OPENAI_API_KEY=$${OPENAI_API_KEY}
OPENAI_BASE_URL=${openai_base_url}

AWS_REGION=${aws_region_runtime}

QDRANT_HOST=mem0_qdrant
QDRANT_PORT=6333

API_HOST=0.0.0.0
API_PORT=${api_port}
API_KEY=$${API_KEY}
ADMIN_API_KEY=$${ADMIN_API_KEY}

LLM_MODEL=${llm_model}
LLM_TEMPERATURE=${llm_temperature}

EMBEDDER_MODEL=${embedder_model}
EOF

echo "=== Starting containers (docker run) ==="

# Create network if missing
docker network inspect mem0_network >/dev/null 2>&1 || docker network create mem0_network

# Start Qdrant (vector DB)
docker rm -f mem0_qdrant >/dev/null 2>&1 || true
docker run -d \
  --name mem0_qdrant \
  --network mem0_network \
  -p 6333:6333 \
  -p 6334:6334 \
  -v qdrant_data:/qdrant/storage \
  -e QDRANT__SERVICE__GRPC_PORT=6334 \
  --restart unless-stopped \
  qdrant/qdrant:latest

# Build API image (uses classic docker build; avoids buildx requirement from docker compose)
docker build -t mem0_api:latest -f deployment/Dockerfile .

# Start Mem0 API
docker rm -f mem0_api >/dev/null 2>&1 || true
docker run -d \
  --name mem0_api \
  --network mem0_network \
  -p ${api_port}:${api_port} \
  --env-file .env \
  -e QDRANT_HOST=mem0_qdrant \
  -e QDRANT_PORT=6333 \
  --restart unless-stopped \
  mem0_api:latest

echo "=== Mem0 Deployment Lab bootstrap complete ==="


